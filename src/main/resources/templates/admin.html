<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Admin Dashboard</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logout-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .logout-button:hover {
            background-color: #a71d2a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        .bug-image {
            max-width: 100px;
            max-height: 75px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        .modal img {
            max-width: 100%;
            max-height: 500px;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>Admin Dashboard</h1>
<div class="header">
    <h2>Welcome, Admin</h2>
    <form th:action="@{/logout}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="logout-button">Logout</button>
    </form>
</div>

<!-- Order By Dropdown -->
<form action="/admin" method="get" style="margin-bottom: 20px;">
    <label for="orderBy"><b>Order By:</b></label>
    <select name="orderBy" id="orderBy" onchange="this.form.submit()">
        <option value="" th:selected="${orderBy == null}">-- Select --</option>
        <option value="urgency" th:selected="${orderBy == 'urgency'}">Urgency (High to Low)</option>
        <option value="recent" th:selected="${orderBy == 'recent'}">Most Recent</option>
    </select>
</form>

<!-- Bug Reports Table -->
<table class="table">
    <thead>
    <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Evidence</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="bug : ${bugs}" th:data-id="${bug.id}" th:data-status="${bug.status}">
        <td th:text="${bug.title}"></td>
        <td th:text="${bug.description}"></td>
        <td th:text="${bug.priority}"></td>
        <td class="bug-status" th:text="${bug.status}"></td>
        <td>
                <span th:if="${bug.filePath}">
                    <img th:src="@{'/uploads/' + ${bug.filePath}}" class="bug-image" onclick="openModal(this.src)" alt="Bug Evidence">
                </span>
            <span th:unless="${bug.filePath}" style="color: red; font-weight: bold;">NO EVIDENCE PROVIDED</span>
        </td>
        <td>
            <label>
                <select class="bugStatusDropdown">
                    <option value="open" th:selected="${bug.status == 'Open'}">Open</option>
                    <option value="in-progress" th:selected="${bug.status == 'In Progress'}">In Progress</option>
                    <option value="resolved" th:selected="${bug.status == 'Resolved'}">Resolved</option>
                </select>
            </label>
            <button class="updateButton">Update</button>
        </td>
    </tr>
    </tbody>
</table>

<!-- Image Modal -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="">
    </div>
</div>

<td>
    <div th:if="${bug.filePath}">
        <!-- Display Image -->
        <div th:if="${#strings.endsWith(bug.filePath, '.jpg') or #strings.endsWith(bug.filePath, '.png')}">
            <img th:src="@{'/uploads/' + ${bug.filePath}}" alt="Bug Evidence" style="max-width: 100px;">
            <a th:href="@{/view-image/{filePath}(filePath=${bug.filePath})}" class="view-button">View Full Image</a>
        </div>

        <!-- Display Video -->
        <div th:if="${#strings.endsWith(bug.filePath, '.mp4') or #strings.endsWith(bug.filePath, '.mov') or #strings.endsWith(bug.filePath, '.avi')}">
            <video controls style="max-width: 150px;">
                <source th:src="@{'/uploads/' + ${bug.filePath}}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <a th:href="@{/view-video/{filePath}(filePath=${bug.filePath})}" class="view-button">View Full Video</a>
        </div>
    </div>
    <div th:if="${bug.filePath == null}">No Evidence</div>
</td>


<script>
    function openModal(src) {
        document.getElementById("modalImage").src = src;
        document.getElementById("imageModal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("imageModal").style.display = "none";
    }

    document.querySelectorAll(".updateButton").forEach(button => {
        button.addEventListener("click", function () {
            let row = this.closest("tr");
            let bugId = row.getAttribute("data-id");
            let newStatus = row.querySelector(".bugStatusDropdown").value;

            if (!bugId || !newStatus) {
                alert("Error: Missing bug ID or status.");
                return;
            }

            let csrfToken = document.querySelector("meta[name='_csrf']").content;
            let csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

            fetch("/admin/update", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    [csrfHeader]: csrfToken
                },
                body: `bugId=${encodeURIComponent(bugId)}&status=${encodeURIComponent(newStatus)}`
            })
                .then(response => response.text())
                .then(data => {
                    console.log("Update Response:", data);
                    row.setAttribute("data-status", newStatus.toLowerCase());
                    row.querySelector(".bug-status").innerText = newStatus;
                    alert("Bug status updated successfully.");
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Failed to update bug status.");
                });
        });
    });
</script>
</body>
</html>




